# Global: default ACME issuer with Cloudflare DNS-01 (token from env CLOUDFLARE_API_TOKEN)
{
    auto_https disable_redirects

	cert_issuer acme {
		dns cloudflare {env.CLOUDFLARE_API_TOKEN}
	}
}

# Tinyauth forward-auth — validates session via Pocket ID (Tinyauth on PocketID host :1412)
(protected) {
    forward_auth 192.168.178.122:1412 {
        # Redirects back to the app after successful login
        uri /api/auth/caddy?redirect_uri=https://{host}{uri}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Method {method}
        header_up X-Forwarded-Uri {uri}
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }
}

# id.mol.la — Pocket ID UI + Tinyauth callback (single identity portal, cookie consistency)
http://id.mol.la, id.mol.la {
    # Match ONLY Tinyauth-specific paths (Pocket ID keeps /api/oidc/*, /authorize, etc.)
    @tinyauth_paths {
        path /api/oauth/* /api/context/* /api/auth/* /api/user/* /api/resources/* /api/healthz /login* /continue* /error* /unauthorized* /assets/* /site.webmanifest /favicon.ico /background.jpg
    }

    # Route Tinyauth traffic
    handle @tinyauth_paths {
        reverse_proxy 192.168.178.122:1412
    }

    # Route everything else to Pocket ID
    handle {
        reverse_proxy 192.168.178.122:1411
    }
}

# Proxmox VE
http://one.mol.la, one.mol.la {
    import protected
    reverse_proxy https://192.168.178.110:8006 {
        transport http {
            tls_server_name one.mol.la
        }
    }
}

# Vault — secrets management
http://vault.mol.la, vault.mol.la {
    import protected
    reverse_proxy 192.168.178.123:8200
}

# Grafana — monitoring
http://grafana.mol.la, grafana.mol.la {
    import protected
    reverse_proxy 192.168.178.124:3000
}

# Jellyfin — media server (media.mol.la)
http://media.mol.la, media.mol.la {
    import protected
    reverse_proxy {{ hostvars['jellyfin'].ansible_host }}:8096
}

# *arr stack — SABnzbd, Prowlarr, Radarr, Sonarr, Bazarr, Jellyseerr (arr LXC)
# Backend: arr_lxc_ip from group_vars/caddy_host or role defaults
http://sabnzbd.mol.la, sabnzbd.mol.la {
    import protected
    reverse_proxy {{ arr_lxc_ip }}:8080
}
http://prowlarr.mol.la, prowlarr.mol.la {
    import protected
    reverse_proxy {{ arr_lxc_ip }}:9696
}
http://radarr.mol.la, radarr.mol.la {
    import protected
    reverse_proxy {{ arr_lxc_ip }}:7878
}
http://sonarr.mol.la, sonarr.mol.la {
    import protected
    reverse_proxy {{ arr_lxc_ip }}:8989
}
http://bazarr.mol.la, bazarr.mol.la {
    import protected
    reverse_proxy {{ arr_lxc_ip }}:6767
}
# Jellyseerr — request/approval UI
http://requests.mol.la, requests.mol.la {
    import protected
    reverse_proxy {{ arr_lxc_ip }}:5055
}

# AdGuard Primary — DNS UI
http://dns1.mol.la, dns1.mol.la {
	reverse_proxy 192.168.178.253:80
}

# AdGuard Secondary — DNS UI
http://dns2.mol.la, dns2.mol.la {
	reverse_proxy 192.168.178.254:80
}
