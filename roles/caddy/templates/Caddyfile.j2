# Tinyauth forward-auth — validates session via Pocket ID (Tinyauth on PocketID host :1412)
(protected) {
    forward_auth 192.168.178.122:1412 {
        # Redirects back to the app after successful login
        uri /api/auth/caddy?redirect_uri=https://{host}{uri}
        header_up X-Forwarded-Host {host}
        header_up X-Forwarded-Proto https
        header_up X-Forwarded-Method {method}
        header_up X-Forwarded-Uri {uri}
        copy_headers Remote-User Remote-Email Remote-Name Remote-Groups
    }
}

# Global: default ACME issuer with Cloudflare DNS-01 (token from env CLOUDFLARE_API_TOKEN)
{
    auto_https disable_redirects

	cert_issuer acme {
		dns cloudflare {env.CLOUDFLARE_API_TOKEN}
	}
}

# Proxmox VE
http://one.mol.la, one.mol.la {
    import protected
    reverse_proxy https://192.168.178.110:8006 {
        transport http {
            tls_server_name one.mol.la
        }
    }
}

# id.mol.la — Pocket ID UI + Tinyauth callback (single identity portal, cookie consistency)
http://id.mol.la, id.mol.la {
    # Match ONLY Tinyauth-specific paths (Pocket ID keeps /api/oidc/*, /authorize, etc.)
    @tinyauth_paths {
        path /api/oauth/* /api/context/* /api/auth/* /api/user/* /api/resources/* /api/healthz /login* /continue* /error* /unauthorized* /assets/* /site.webmanifest /favicon.ico /background.jpg
    }

    # Route Tinyauth traffic
    handle @tinyauth_paths {
        reverse_proxy 192.168.178.122:1412
    }

    # Route everything else to Pocket ID
    handle {
        reverse_proxy 192.168.178.122:1411
    }
}

# AdGuard Primary — DNS UI
http://dns1.mol.la, dns1.mol.la {
	reverse_proxy 192.168.178.253:80
}

# AdGuard Secondary — DNS UI
http://dns2.mol.la, dns2.mol.la {
	reverse_proxy 192.168.178.254:80
}
