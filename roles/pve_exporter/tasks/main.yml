---
- name: Install Python venv package
  ansible.builtin.apt:
    name:
      - python3-venv
      - python3-pip
    state: present
    update_cache: true

- name: Create pve-exporter system user
  ansible.builtin.user:
    name: "{{ pve_exporter_user }}"
    system: true
    shell: /usr/sbin/nologin
    create_home: false

- name: Create Python virtual environment
  ansible.builtin.command:
    cmd: python3 -m venv {{ pve_exporter_venv }}
    creates: "{{ pve_exporter_venv }}/bin/python"

- name: Install prometheus-pve-exporter in venv
  ansible.builtin.pip:
    name: "prometheus-pve-exporter=={{ pve_exporter_version }}"
    virtualenv: "{{ pve_exporter_venv }}"
    state: present

- name: Fetch PVE API credentials from Vault
  community.hashi_vault.vault_read:
    url: "{{ vault_addr }}"
    path: "{{ pve_exporter_vault_path }}"
    auth_method: approle
    role_id: "{{ vault_role_id }}"
    secret_id: "{{ vault_secret_id }}"
  register: pve_vault_secret
  delegate_to: localhost
  become: false

- name: Create config directory
  ansible.builtin.file:
    path: "{{ pve_exporter_config | dirname }}"
    state: directory
    mode: '0750'
    owner: root
    group: "{{ pve_exporter_user }}"

- name: Deploy pve.yml config
  ansible.builtin.template:
    src: pve.yml.j2
    dest: "{{ pve_exporter_config }}"
    mode: '0640'
    owner: root
    group: "{{ pve_exporter_user }}"
  notify: Restart pve-exporter
  no_log: true

- name: Deploy systemd service
  ansible.builtin.template:
    src: pve-exporter.service.j2
    dest: /etc/systemd/system/pve-exporter.service
    mode: '0644'
  notify: Restart pve-exporter

- name: Enable and start pve-exporter
  ansible.builtin.systemd:
    name: pve-exporter
    state: started
    enabled: true
    daemon_reload: true
