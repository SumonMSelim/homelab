---
- name: Fetch Immich DB password from Vault
  community.hashi_vault.vault_read:
    url: "{{ vault_addr }}"
    path: "{{ immich_db_vault_secret_path }}"
    auth_method: approle
    role_id: "{{ vault_role_id }}"
    secret_id: "{{ vault_secret_id }}"
  register: immich_db_vault_secret
  delegate_to: localhost
  become: false

- name: Fetch Redis password from Vault
  community.hashi_vault.vault_read:
    url: "{{ vault_addr }}"
    path: "{{ immich_redis_vault_secret_path }}"
    auth_method: approle
    role_id: "{{ vault_role_id }}"
    secret_id: "{{ vault_secret_id }}"
  register: immich_redis_vault_secret
  delegate_to: localhost
  become: false

- name: Fetch Immich OIDC credentials from Vault
  community.hashi_vault.vault_read:
    url: "{{ vault_addr }}"
    path: "{{ immich_oidc_vault_secret_path }}"
    auth_method: approle
    role_id: "{{ vault_role_id }}"
    secret_id: "{{ vault_secret_id }}"
  register: immich_oidc_vault_secret
  delegate_to: localhost
  become: false
  when: immich_oidc_enabled | default(false) | bool

- name: Set Immich credentials from Vault
  ansible.builtin.set_fact:
    immich_db_password: "{{ immich_db_vault_secret.data.data.data[immich_db_password_vault_key] }}"
    immich_redis_password: "{{ immich_redis_vault_secret.data.data.data[immich_redis_vault_key] }}"

- name: Ensure compose project directory exists
  ansible.builtin.file:
    path: "/opt/compose/immich-{{ inventory_hostname }}"
    state: directory
    mode: '0755'

- name: Ensure Immich upload directory exists
  ansible.builtin.file:
    path: "{{ immich_upload_path }}"
    state: directory
    mode: '0755'

- name: Deploy Immich .env file
  ansible.builtin.template:
    src: env.j2
    dest: "/opt/compose/immich-{{ inventory_hostname }}/.env"
    mode: '0600'
  no_log: true
  notify: Restart Immich

- name: Deploy Immich OIDC config file
  ansible.builtin.template:
    src: immich_config.json.j2
    dest: "/opt/compose/immich-{{ inventory_hostname }}/immich.json"
    mode: '0600'
  no_log: true
  notify: Restart Immich
  when: immich_oidc_enabled | default(false) | bool

- name: Deploy Immich compose file
  ansible.builtin.template:
    src: compose.yml.j2
    dest: "/opt/compose/immich-{{ inventory_hostname }}/compose.yml"
    mode: '0644'
  notify: Restart Immich

- name: Start Immich with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "/opt/compose/immich-{{ inventory_hostname }}"
    state: present
