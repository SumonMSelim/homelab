---
- name: Check if user {{ app.user }} exists on {{ app.db }}
  ansible.builtin.shell: >
    mongosh --quiet
    -u "{{ mongodb_admin_user }}"
    -p "{{ mongo_vault_secret.data.data.data[mongodb_admin_vault_key] }}"
    --authenticationDatabase admin
    --eval 'db.getSiblingDB("{{ app.db }}").getUser("{{ app.user }}")'
    | grep -c '"user"'
  register: app_user_check
  changed_when: false
  failed_when: false
  no_log: true

- name: Create user {{ app.user }} on {{ app.db }}
  ansible.builtin.shell: >
    mongosh --quiet
    -u "{{ mongodb_admin_user }}"
    -p "{{ mongo_vault_secret.data.data.data[mongodb_admin_vault_key] }}"
    --authenticationDatabase admin
    --eval '
    db.getSiblingDB("{{ app.db }}").createUser({
      user: "{{ app.user }}",
      pwd: "{{ mongo_vault_secret.data.data.data[app.vault_key] }}",
      roles: [{ role: "readWrite", db: "{{ app.db }}" }]
    })'
  when: app_user_check.stdout | default("0") | trim == "0"
  no_log: true
