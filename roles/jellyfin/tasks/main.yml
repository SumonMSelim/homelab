---
# Jellyfin media server in Docker. Requires LXC to have media path (e.g. /media) bind-mounted from Proxmox.
- name: Ensure compose project directory exists
  ansible.builtin.file:
    path: "/opt/compose/jellyfin-{{ inventory_hostname }}"
    state: directory
    mode: '0755'

- name: Check media path exists (bind-mount from Proxmox media-storage before deploy)
  ansible.builtin.stat:
    path: "{{ jellyfin_media_path }}"
  register: media_path_stat

- name: Fail if media path is missing
  ansible.builtin.fail:
    msg: "Media path '{{ jellyfin_media_path }}' must exist on the LXC. Add a bind mount in Proxmox (e.g. mp0=/path/to/media-storage,{{ jellyfin_media_path }}) and create the LXC mount point."
  when: not media_path_stat.stat.exists or not media_path_stat.stat.isdir

- name: Deploy Jellyfin compose file
  ansible.builtin.template:
    src: compose.yml.j2
    dest: "/opt/compose/jellyfin-{{ inventory_hostname }}/compose.yml"
    mode: '0644'
  notify: Restart Jellyfin

- name: Start Jellyfin with Docker Compose
  community.docker.docker_compose_v2:
    project_src: "/opt/compose/jellyfin-{{ inventory_hostname }}"
    state: present
